import json
import requests
import urllib
from flask import Flask, request,render_template

app = Flask(__name__)

class IPQS:
    key = 'DaJXmdUBpvXSTPfYIo3PcbRI3lgHynaQ'

    def malicious_url_scanner_api(self, url: str, vars: dict = {}) -> dict:
        target_url = 'https://www.ipqualityscore.com/api/json/url/%s/%s' % (self.key, urllib.parse.quote_plus(url))
        x = requests.get(target_url, params=vars)
        return (json.loads(x.text))


@app.route('/')
def index():
    return render_template("index.html")

@app.route('/predict', methods=['GET','POST'])
def predict():
    target_url = request.form['target_url']
    strictness = 0
    additional_params = {
        'strictness': strictness
    }
    ipqs = IPQS()
    result = ipqs.malicious_url_scanner_api(target_url, additional_params)
    if 'success' in result and result['success'] == True:
        output = {
            'url': result['domain'],
            'ip_address': result['ip_address'],
            'country_code': result['country_code'],
            'language_code': result['language_code'],
            'server': result['server'],
            'content_type': result['content_type'],
            'risk_score': result['risk_score'],
            'status_code': result['status_code'],
            'page_size': result['page_size'],
            'domain_rank': result['domain_rank'],
            'dns_valid': result['dns_valid'],
            'suspicious': result['suspicious'],
            'phishing': result['phishing'],
            'malware': result['malware'],
            'parking': result['parking'],
            'spamming': result['spamming'],
            'adult': result['adult'],
            'category': result['category'],
            'domain_age': result['domain_age']['human'],
            'domain': result['domain']
        }
        return render_template('results.html', output=output)
    else:
        return "Error occurred while scanning the URL."

if __name__ == '__main__':
    app.run(debug=True)
